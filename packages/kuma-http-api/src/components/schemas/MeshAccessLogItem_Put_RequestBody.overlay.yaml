overlay: 1.0.0
info:
  title: Customise MeshAccessLog
  version: 0.1.0
extends: ../../../generated/components/schemas/MeshAccessLogItem.yaml
actions:
  # mark as a request body so we can make amends for request bodies
  - target: '$'
    update:
      x-request: true

  # default specs.default just for this policy
  - target: '$.properties.spec.properties.to.items'
    update:
      default:
        targetRef:
          kind: MeshService
        default:
          backends: []
  - target: '$.properties.spec.properties.rules.items'
    update:
      default:
        targetRef:
          kind: MeshService
        default:
          backends: []

  - target: '$..backends.items.properties'
    remove: true
  # Update all backends.items locations using recursive descent
  - target: '$..backends.items'
    update:
      default:
        type: File
        file:
          path: ''
  - target: '$..backends.items'
    update:
      properties:
        type:
          type: string
          enum: [Tcp, File, OpenTelemetry]
      oneOf:
        - title: TCP
          type: object
          default:
            type: Tcp
            tcp:
              address: ''
          properties:
            type: { const: Tcp }
            tcp:
              properties:
                address:
                  description: Address of the TCP logging backend
                  type: string
                  example: '127.0.0.1:5000'
                  minLength: 1
                format:
                  readOnly: true # temporary to hide this property form the form
                  description: |-
                    Format of access logs. Placeholders available on
                    https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators
                  type: object
                  properties:
                    json:
                      type: array
                      items:
                        properties:
                          key:
                            type: string
                          value:
                            type: string
                        required:
                          - key
                          - value
                        type: object
                      example:
                        - key: start_time
                          value: '%START_TIME%'
                        - key: bytes_received
                          value: '%BYTES_RECEIVED%'
                    omitEmptyValues:
                      type: boolean
                      default: false
                    plain:
                      type: string
                      example: '[%START_TIME%] %KUMA_MESH% %UPSTREAM_HOST%'
                    type:
                      type: string
                      enum:
                        - Plain
                        - Json
                  required:
                    - type
              required:
                - address
        - title: File
          type: object
          default:
            type: File
            file:
              path: ''
          properties:
            type: { const: File }
            file:
              description: FileBackend defines configuration for file based access logs
              type: object
              properties:
                format:
                  readOnly: true # temporary to hide this property form the form
                  description: |-
                    Format of access logs. Placeholders available on
                    https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators
                  type: object
                  properties:
                    json:
                      type: array
                      items:
                        properties:
                          key:
                            type: string
                          value:
                            type: string
                        required:
                          - key
                          - value
                        type: object
                      example:
                        - key: start_time
                          value: '%START_TIME%'
                        - key: bytes_received
                          value: '%BYTES_RECEIVED%'
                    omitEmptyValues:
                      type: boolean
                      default: false
                    plain:
                      type: string
                      example: '[%START_TIME%] %KUMA_MESH% %UPSTREAM_HOST%'
                    type:
                      type: string
                      enum:
                        - Plain
                        - Json
                  required:
                    - type
                path:
                  description: Path to a file that logs will be written to
                  type: string
                  example: /tmp/access.log
                  minLength: 1
              required:
                - path
        - title: OpenTelemetry
          type: object
          default:
            type: OpenTelemetry
            openTelemetry:
              endpoint: ''
          properties:
            type: { const: OpenTelemetry }
            openTelemetry:
              properties:
                attributes:
                  readOnly: true # temporary to hide this property form the form
                  description: |-
                    Attributes can contain placeholders available on
                    https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators
                  type: array
                  items:
                    properties:
                      key:
                        type: string
                      value:
                        type: string
                    required:
                      - key
                      - value
                    type: object
                  example:
                    - key: mesh
                      value: '%KUMA_MESH%'
                body:
                  description: |-
                    Body is a raw string or an OTLP any value as described at
                    https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/logs/data-model.md#field-body
                    It can contain placeholders available on
                    https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators
                  example:
                    kvlistValue:
                      values:
                        - key: mesh
                          value:
                            stringValue: '%KUMA_MESH%'
                  x-kubernetes-preserve-unknown-fields: true
                endpoint:
                  description: Endpoint of OpenTelemetry collector. An empty port defaults to 4317.
                  type: string
                  example: 'otel-collector:4317'
                  minLength: 1
              required:
                - endpoint

