overlay: 1.0.0
info:
  title: Customise MeshAccessLog
  version: 0.1.0
extends: ../../../generated/components/schemas/MeshAccessLogItem.yaml
actions:
  # mark as a request body so we can make amends for request bodies
  - target: '$'
    update:
      x-request: true

  # default specs.default just for this policy
  - target: '$.properties.spec.properties.to.items'
    update:
      default:
        targetRef:
          kind: MeshService
        default:
          backends: []
  - target: '$.properties.spec.properties.rules.items'
    update:
      default:
        targetRef:
          kind: MeshService
        default:
          backends: []

  # Update all backends.items locations using recursive descent
  # file/tcp/opentelemetry should be oneOf
  - target: '$..backends.items.properties.file'
    remove: true
  - target: '$..backends.items.properties.tcp'
    remove: true
  - target: '$..backends.items.properties.openTelemetry'
    remove: true

  - target: '$..backends.items'
    update:
      default:
        type: File
        file:
          path: ''
      oneOf:
        - title: TCP
          type: object
          default:
            type: Tcp
            tcp:
              address: ''
          properties:
            type: { const: Tcp }
            tcp:
              $ref: !!oas-overlay/dereference '../../../generated/components/schemas/MeshAccessLogItem.yaml#/properties/spec/properties/to/items/properties/default/properties/backends/items/properties/tcp'
        - title: File
          type: object
          default:
            type: File
            file:
              path: ''
          properties:
            type: { const: File }
            file:
              $ref: !!oas-overlay/dereference '../../../generated/components/schemas/MeshAccessLogItem.yaml#/properties/spec/properties/to/items/properties/default/properties/backends/items/properties/file'

        - title: OpenTelemetry
          type: object
          default:
            type: OpenTelemetry
            openTelemetry:
              endpoint: ''
          properties:
            type: { const: OpenTelemetry }
            openTelemetry:
              $ref: !!oas-overlay/dereference '../../../generated/components/schemas/MeshAccessLogItem.yaml#/properties/spec/properties/to/items/properties/default/properties/backends/items/properties/openTelemetry'

  ###
  # file and tcp format should be oneOf
  - target: '$..backends.items..format.properties.json'
    remove: true
  - target: '$..backends.items..format.properties.plain'
    remove: true
  - target: '$..backends.items.oneOf[0].properties.tcp.properties.format'
    update:
      # plain/json should be oneOf
      oneOf:
        - title: JSON
          type: object
          default:
            type: Json
            json: []
          properties:
            type: { const: Json }
            json:
              $ref: !!oas-overlay/dereference '../../../generated/components/schemas/MeshAccessLogItem.yaml#/properties/spec/properties/to/items/properties/default/properties/backends/items/properties/tcp/properties/format/properties/json'
        - title: Plain
          type: object
          default:
            type: Plain
            plain: '[%START_TIME%] %KUMA_MESH% %UPSTREAM_HOST%'
          properties:
            type: { const: Plain }
            plain:
              $ref: !!oas-overlay/dereference '../../../generated/components/schemas/MeshAccessLogItem.yaml#/properties/spec/properties/to/items/properties/default/properties/backends/items/properties/tcp/properties/format/properties/plain'
  - target: '$..backends.items.oneOf[1].properties.file.properties.format'
    update:
      oneOf:
        - title: JSON
          type: object
          default:
            type: Json
            json: []
          properties:
            type: { const: Json }
            json:
              $ref: !!oas-overlay/dereference '../../../generated/components/schemas/MeshAccessLogItem.yaml#/properties/spec/properties/to/items/properties/default/properties/backends/items/properties/file/properties/format/properties/json'
        - title: Plain
          type: object
          default:
            type: Plain
            plain: '[%START_TIME%] %KUMA_MESH% %UPSTREAM_HOST%'
          properties:
            type: { const: Plain }
            plain:
              $ref: !!oas-overlay/dereference '../../../generated/components/schemas/MeshAccessLogItem.yaml#/properties/spec/properties/to/items/properties/default/properties/backends/items/properties/file/properties/format/properties/plain'
